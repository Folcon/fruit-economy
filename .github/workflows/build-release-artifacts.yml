name: Build Release Artifacts
on:
  release:
    types: [created]
jobs:
  build-deb:
    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    runs-on: ${{ matrix.os }}
    steps:
      - name: checkout
      - uses: actions/checkout@v2

      - name: prepare java
      - uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: install clojure
      - uses: DeLaGuardo/setup-clojure@3.7
        with:
          lein: latest

      - name: build uberjar
        run: lein uberjar

      - name: build package on linux
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: jpackage @jpackage/common @jpackage/linux

      - name: build package on macos
        if: ${{ matrix.os == 'macos-latest' }}
        run: jpackage @jpackage/common @jpackage/mac

      - name: build package on windows
        if: ${{ matrix.os == 'windows-latest' }}
        run: jpackage @jpackage/common @jpackage/windows

      - name: release artifacts on linux
        if: ${{ matrix.os == 'ubuntu-latest' }}
        uses: softprops/action-gh-release@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: fruit-economy-${{ github.ref_name }}-amd64.deb
          asset_name: fruit-economy-${{ github.ref_name }}-amd64.deb
          asset_content_type: application/vnd.debian.binary-package

      - name: release artifacts on macos
        if: ${{ matrix.os == 'macos-latest' }}
        uses: softprops/action-gh-release@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: fruit-economy-${{ github.ref_name }}.dmg
          asset_name: fruit-economy-${{ github.ref_name }}.dmg
          asset_content_type: application/x-apple-diskimage

      - name: release artifacts on windows
        if: ${{ matrix.os == 'windows-latest' }}
        uses: softprops/action-gh-release@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: fruit-economy-${{ github.ref_name }}.exe
          asset_name: fruit-economy-${{ github.ref_name }}.exe
          asset_content_type: application/vnd.microsoft.portable-executable
